#!/usr/bin/env ruby
# bin/grpc_server

require 'grpc'
require 'logger'

# Rails 환경 로드
require File.expand_path('../../config/environment', __FILE__)

# gRPC 스텁 파일들이 있는 디렉토리를 Ruby 로드 경로에 추가합니다.
# 생성된 스텁 파일들은 app/grpc 디렉토리에 있습니다.
grpc_dir = File.expand_path('../grpc', __dir__)
$LOAD_PATH.unshift(grpc_dir) unless $LOAD_PATH.include?(grpc_dir)

# 필요한 gRPC 파일 로드
# 메시지 정의 파일들을 먼저 로드합니다.
require 'room_pb'
require 'reservation_pb'
require 'room_operating_hour_pb'
require 'room_exception_pb'

# 서비스 정의 파일들을 로드합니다.
require 'room_services_pb'
require 'reservation_services_pb'
require 'room_operating_hour_services_pb'
require 'room_exception_services_pb'

# 서비스 구현체 로드
# 모든 gRPC 서비스 구현은 app/services/grpc_server.rb 파일에 있습니다.
require_relative '../app/services/grpc_server'

# 서버 시작
addr = '0.0.0.0:50051'
logger = Logger.new($stdout)
logger.info("gRPC server listening on #{addr}")

server = GRPC::RpcServer.new
server.add_http2_port(addr, :this_port_is_insecure)

# 서비스 핸들러 등록
# app/services/grpc_server.rb 파일에 정의된 클래스들을 사용합니다.
server.handle(RoomService)
server.handle(ReservationService)
server.handle(RoomOperatingHourService)
server.handle(RoomExceptionService)

server.run_till_terminated
